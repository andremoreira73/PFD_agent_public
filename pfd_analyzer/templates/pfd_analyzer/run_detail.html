<!-- templates/pfd_analyzer/run_detail.html -->
{% extends 'pfd_analyzer/base_analyzer.html' %}
<!---->
{% block title %}Run #{{ run.pk }} - PFD Analyzer
<!-- -->
{% endblock %} {% block content %}
<div class="max-w-5xl mx-auto space-y-6">
  <!-- Header: Run # and PDF File combined -->
  <div class="bg-white shadow rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">
          {% if run.name %}Run #{{ run.pk }}: {{ run.name }}<!-- -->
          {% else %}Run #{{ run.pk }}{% endif %}
        </h1>
        <p class="text-gray-600 mt-1">
          {{ run.model }} • Created
          <!-- -->
          {{ run.created_at|date:"M d, Y \a\t g:i A" }}
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <!-- Lock/Unlock Button -->
        {% if run.is_locked %}
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
        >
          <i class="fas fa-lock mr-1"></i> Locked
        </span>
        <a
          href="{% url 'pfd_analyzer:unlock_run' run.pk %}"
          class="inline-flex items-center px-3 py-2 border border-yellow-300 text-sm font-medium rounded-md text-yellow-700 bg-yellow-50 hover:bg-yellow-100"
        >
          <i class="fas fa-unlock mr-2"></i> Unlock
        </a>
        {% else %}
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
        >
          <i class="fas fa-unlock mr-1"></i> Unlocked
        </span>
        <a
          href="{% url 'pfd_analyzer:lock_run' run.pk %}"
          class="inline-flex items-center px-3 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-blue-50 hover:bg-blue-100"
        >
          <i class="fas fa-lock mr-2"></i> Lock
        </a>
        {% endif %}

        <!-- Edit Button -->
        <a
          href="{% url 'pfd_analyzer:run_edit' run.pk %}"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
        >
          <i class="fas fa-edit mr-2"></i> Edit
        </a>
      </div>
    </div>

    <!-- PDF File Info -->
    <div class="border-t border-gray-200 pt-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-file-pdf text-red-600 text-xl"></i>
          <div>
            <h3 class="text-sm font-medium text-gray-900">
              <a
                href="{% url 'pfd_analyzer:pfd_file_detail' run.pfd_file.pk %}"
                class="text-blue-600 hover:underline"
              >
                {{ run.pfd_file.name }}
              </a>
            </h3>
            <p class="text-xs text-gray-500">
              Uploaded {{ run.pfd_file.uploaded_at|date:"M d, Y" }}
            </p>
          </div>
        </div>
        <a
          href="{{ run.pfd_file.file.url }}"
          target="_blank"
          class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
        >
          <i class="fas fa-external-link-alt mr-2"></i>
          View PDF
        </a>
      </div>
    </div>
  </div>

  <!-- LLM Output (Full Width) -->
  <div class="bg-white shadow rounded-lg p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-medium text-gray-900">LLM Output</h2>
      {% if run.is_locked %}
      <span
        class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800"
      >
        <i class="fas fa-lock mr-1"></i> Protected
      </span>
      {% endif %}
    </div>
    {% load markdown_extras %}<!--
        -->
    <div
      class="markdown-content prose prose-sm max-w-none bg-gray-50 rounded-lg p-4 border"
    >
      {{ run.llm_output_markdown|render_markdown }}
    </div>
  </div>

  <!-- Comments & Analysis (Full Width) -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Comments & Analysis</h2>
    {% if run.comments_markdown %} {% load markdown_extras %}<!--
            -->
    <div
      class="markdown-content prose prose-sm max-w-none bg-gray-50 rounded-lg p-4 border"
    >
      {{ run.comments_markdown|render_markdown }}
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500">
      <i class="fas fa-comments text-2xl mb-2"></i>
      <p>No comments yet.</p>
      <a
        href="{% url 'pfd_analyzer:run_edit' run.pk %}"
        class="text-blue-600 hover:underline"
        >Add comments</a
      >
    </div>
    {% endif %}
  </div>

  <!-- Evaluation Metrics -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-3">Evaluation Metrics</h2>

    <!-- Confusion Matrix (First Row) -->
    <div class="flex flex-wrap gap-2 mb-2">
      <div
        class="flex-1 min-w-0 bg-green-50 border border-green-200 rounded p-2 text-center"
      >
        <div class="text-base font-bold text-green-800">
          {{ run.true_positives }}
        </div>
        <div class="text-xs text-green-600">True Positives</div>
      </div>
      <div
        class="flex-1 min-w-0 bg-red-50 border border-red-200 rounded p-2 text-center"
      >
        <div class="text-base font-bold text-red-800">
          {{ run.false_positives }}
        </div>
        <div class="text-xs text-red-600">False Positives</div>
      </div>
      <div
        class="flex-1 min-w-0 bg-blue-50 border border-blue-200 rounded p-2 text-center"
      >
        <div class="text-base font-bold text-blue-800">
          {{ run.true_negatives }}
        </div>
        <div class="text-xs text-blue-600">True Negatives</div>
      </div>
      <div
        class="flex-1 min-w-0 bg-yellow-50 border border-yellow-200 rounded p-2 text-center"
      >
        <div class="text-base font-bold text-yellow-800">
          {{ run.false_negatives }}
        </div>
        <div class="text-xs text-yellow-600">False Negatives</div>
      </div>
    </div>

    <!-- Calculated Metrics (Second Row) -->
    <div class="flex flex-wrap gap-2">
      <div class="flex-1 min-w-0 text-center p-2 bg-gray-50 rounded">
        <div class="text-base font-bold text-gray-900">{{ run.accuracy }}%</div>
        <div class="text-xs text-gray-500">Accuracy</div>
      </div>
      <div class="flex-1 min-w-0 text-center p-2 bg-gray-50 rounded">
        <div class="text-base font-bold text-gray-900">
          {{ run.precision }}%
        </div>
        <div class="text-xs text-gray-500">Precision</div>
      </div>
      <div class="flex-1 min-w-0 text-center p-2 bg-gray-50 rounded">
        <div class="text-base font-bold text-gray-900">{{ run.recall }}%</div>
        <div class="text-xs text-gray-500">Recall</div>
      </div>
      <div class="flex-1 min-w-0 text-center p-2 bg-gray-50 rounded">
        <div class="text-base font-bold text-gray-900">
          {{ run.text_style_score }}%
        </div>
        <div class="text-xs text-gray-500">Text Style Score</div>
      </div>
    </div>
  </div>

  <!-- Technical Details -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Technical Details</h2>
    <dl class="grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2">
      <div>
        <dt class="text-sm font-medium text-gray-500">Model</dt>
        <dd class="text-sm text-gray-900">{{ run.model }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Response ID</dt>
        <dd class="text-sm text-gray-900 font-mono">
          {{ run.response_id|default:"—" }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">System Prompt</dt>
        <dd class="text-sm text-gray-900">{{ run.prompt_system }}</dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">User Prompt</dt>
        <dd class="text-sm text-gray-900">{{ run.prompt_user }}</dd>
      </div>
      <div class="sm:col-span-2">
        <dt class="text-sm font-medium text-gray-500">Parameters</dt>
        <dd class="text-sm text-gray-900">{{ run.parameters|default:"—" }}</dd>
      </div>
      <div class="sm:col-span-2">
        <dt class="text-sm font-medium text-gray-500">Total Tokens</dt>
        <dd class="text-sm text-gray-900">
          {{ run.total_tokens|floatformat:0 }}
          <span class="text-gray-500">
            ({{ run.tokens_input }} input + {{ run.tokens_output_text }} text +
            {{ run.tokens_output_reasoning }} reasoning)
          </span>
        </dd>
      </div>
    </dl>
  </div>

  <!-- Metadata -->
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Metadata</h2>
    <dl class="grid grid-cols-1 gap-x-4 gap-y-3 sm:grid-cols-2">
      <div>
        <dt class="text-sm font-medium text-gray-500">Created by</dt>
        <dd class="text-sm text-gray-900">
          {{ run.created_by.first_name|default:run.created_by.username }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Created at</dt>
        <dd class="text-sm text-gray-900">
          {{ run.created_at|date:"F j, Y \a\t g:i A" }}
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">Last updated</dt>
        <dd class="text-sm text-gray-900">
          {{ run.updated_at|date:"F j, Y \a\t g:i A" }}
        </dd>
      </div>
      {% if run.locked_by %}
      <div>
        <dt class="text-sm font-medium text-gray-500">Locked by</dt>
        <dd class="text-sm text-gray-900">
          {{ run.locked_by.first_name|default:run.locked_by.username }}
          <span class="text-gray-500"
            >on {{ run.locked_at|date:"M j, Y \a\t g:i A" }}</span
          >
        </dd>
      </div>
      {% endif %}
    </dl>
  </div>

  <!-- Run Relationships -->
  {% if run.related_run or run.relationship_description %}
  <div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">Run Relationships</h2>
    <dl class="grid grid-cols-1 gap-x-4 gap-y-3">
      {% if run.related_run %}
      <div>
        <dt class="text-sm font-medium text-gray-500">Related to</dt>
        <dd class="text-sm text-gray-900">
          <a
            href="{% url 'pfd_analyzer:run_detail' run.related_run.pk %}"
            class="text-blue-600 hover:underline"
          >
            {% if run.related_run.name %}{{ run.related_run.name }}{% else %}
            <!---->
            Run #{{ run.related_run.pk }}{% endif %}
          </a>
        </dd>
      </div>
      {% endif %} {% if run.relationship_description %}
      <div>
        <dt class="text-sm font-medium text-gray-500">Relationship</dt>
        <dd class="text-sm text-gray-900">
          {{ run.relationship_description }}
        </dd>
      </div>
      {% endif %}
    </dl>
  </div>
  {% endif %}

  <!-- Navigation -->
  <div class="flex items-center justify-between">
    <a
      href="{% url 'pfd_analyzer:run_list' %}"
      class="text-gray-600 hover:text-gray-900 text-sm font-medium"
    >
      <i class="fas fa-arrow-left mr-1"></i> Back to Runs
    </a>
    <div class="space-x-3">
      <a
        href="{% url 'pfd_analyzer:new_run' %}"
        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
      >
        <i class="fas fa-plus mr-2"></i> New Run
      </a>
    </div>
  </div>
</div>
{% endblock %}
