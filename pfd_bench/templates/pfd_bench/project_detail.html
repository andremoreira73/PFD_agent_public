<!-- pfd_bench/templates/pfd_bench/project_detail.html -->
{% extends 'pfd_bench/base_bench.html' %}
<!-- -->
{% block title %}{{ project.name }} - PFD Agent {%endblock %}
<!-- -->
{% block content %}
<div class="min-h-screen bg-gray-50">
  <!-- Breadcrumbs -->
  <div class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <nav class="text-sm text-gray-500">
        <a href="{% url 'pfd_bench:dashboard' %}" class="hover:text-gray-700"
          >Projects</a
        >
        <span class="mx-2">/</span>
        <span class="text-gray-900">{{ project.name }}</span>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Project Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">{{ project.name }}</h1>
      {% if project.description %}
      <p class="mt-2 text-gray-600">{{ project.description }}</p>
      {% endif %}
    </div>

    <!-- Two Panel Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Runs Panel -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Runs</h2>
            <button
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              hx-get="{% url 'pfd_bench:new_run_modal' project.id %}"
              hx-target="#modal-container"
              hx-swap="innerHTML"
            >
              Start a new run
            </button>
          </div>

          <!-- Search and Filter -->
          <div class="space-y-3">
            <input
              type="text"
              placeholder="Search runs..."
              class="w-full px-3 py-2 border rounded-md"
              hx-get="{% url 'pfd_bench:runs_list' project.id %}"
              hx-trigger="keyup changed delay:300ms"
              hx-target="#runs-list"
              hx-include="#status-filter"
              name="search"
            />

            <select
              id="status-filter"
              class="w-full px-3 py-2 border rounded-md"
              hx-get="{% url 'pfd_bench:runs_list' project.id %}"
              hx-trigger="change"
              hx-target="#runs-list"
              hx-include="[name='search']"
              name="status"
            >
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="ready_for_review">Ready for Review</option>
              <option value="under_review">Under Review</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
          </div>
        </div>

        <!-- Runs List -->
        <div
          id="runs-list"
          class="max-h-96 overflow-y-auto"
          hx-get="{% url 'pfd_bench:runs_list' project.id %}"
          hx-trigger="load"
          hx-swap="innerHTML"
        >
          <div class="p-4 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin"></i> Loading runs...
          </div>
        </div>
      </div>

      <!-- Files Panel -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Files</h2>
            <button
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
              hx-get="{% url 'pfd_bench:upload_file_modal' project.id %}"
              hx-target="#modal-container"
              hx-swap="innerHTML"
            >
              Upload a file
            </button>
          </div>

          <!-- Search -->
          <input
            type="text"
            placeholder="Search files..."
            class="w-full px-3 py-2 border rounded-md"
            hx-get="{% url 'pfd_bench:files_list' project.id %}"
            hx-trigger="keyup changed delay:300ms"
            hx-target="#files-list"
            name="search"
          />
        </div>

        <!-- Files List -->
        <div
          id="files-list"
          class="max-h-96 overflow-y-auto"
          hx-get="{% url 'pfd_bench:files_list' project.id %}"
          hx-trigger="load, refresh-files from:body"
          hx-swap="innerHTML"
        >
          <div class="p-4 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin"></i> Loading files...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<script>
  // Listen for HTMX afterSwap events on the runs list
  document.addEventListener("htmx:afterSwap", function (event) {
    // Check if the swap happened on the runs-list element
    if (
      event.detail.target.id === "runs-list" ||
      event.detail.target.closest("#runs-list")
    ) {
      // Small delay to ensure DOM is updated
      setTimeout(() => {
        // Trigger refresh of files list
        htmx.trigger("#files-list", "refresh-files");
      }, 100);
    }
  });

  // Alternative: Listen for successful DELETE requests
  document.addEventListener("htmx:afterRequest", function (event) {
    // Check if it was a DELETE request to a run
    if (
      event.detail.verb === "DELETE" &&
      event.detail.pathInfo.path.includes("/run/") &&
      event.detail.pathInfo.path.includes("/delete/")
    ) {
      // Trigger refresh of files list
      setTimeout(() => {
        htmx.trigger("#files-list", "refresh-files");
      }, 100);
    }
  });
</script>
{% endblock %}
