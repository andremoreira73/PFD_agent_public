<!-- pfd_bench/templates/pfd_bench/partials/new_run_modal.html -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  hx-on:click="if(event.target === this) { event.stopPropagation(); this.remove(); }"
>
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Start a New Run</h2>

    <form
      hx-post="{% url 'pfd_bench:create_run' project.id %}"
      hx-encoding="multipart/form-data"
      hx-target="#runs-list"
      hx-swap="none"
      hx-on:htmx:after-request="
        if(event.detail.successful) {
          if(event.detail.xhr.getResponseHeader('HX-Redirect')) {
            window.location.href = event.detail.xhr.getResponseHeader('HX-Redirect');
          }
          document.getElementById('modal-container').innerHTML = '';
        }
      "
    >
      {% csrf_token %}

      <!-- Run Name -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Run Name
        </label>
        <input
          type="text"
          name="name"
          required
          class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
          placeholder="e.g., Initial Analysis, Revision 2"
        />
      </div>

      <!-- File Selection -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Select DXF File
        </label>

        <div class="space-y-2">
          <!-- Existing Files -->
          {% if existing_files %}
          <div class="border rounded-md p-3 max-h-48 overflow-y-auto">
            <p class="text-sm text-gray-600 mb-2">Choose existing file:</p>
            {% for file in existing_files %}
            <label
              class="flex items-center p-2 hover:bg-gray-50 cursor-pointer"
            >
              <input
                type="radio"
                name="project_file_id"
                value="{{ file.id }}"
                class="mr-2"
                hx-on:change="document.getElementById('file-upload').value = ''"
              />
              <span class="text-sm">{{ file.name }}</span>
              <span class="text-xs text-gray-500 ml-auto"
                >{{ file.file_size_display }}</span
              >
            </label>
            {% endfor %}
          </div>

          <div class="text-center text-sm text-gray-500">— or —</div>
          {% endif %}

          <!-- Upload New -->
          <div class="border-2 border-dashed rounded-md p-4">
            <label class="cursor-pointer block text-center">
              <input
                type="file"
                id="file-upload"
                name="project_file"
                accept=".dxf"
                class="hidden"
                hx-on:change="
                  document.querySelectorAll('input[name=project_file_id]').forEach(el => el.checked = false);
                  const fileName = this.files[0]?.name || 'Click to browse';
                  document.getElementById('file-name-display').textContent = fileName;
                "
              />
              <i class="fas fa-upload text-gray-400 text-2xl mb-2"></i>
              <p class="text-sm text-gray-600">Upload new DXF file</p>
              <p id="file-name-display" class="text-xs text-gray-500 mt-1">
                Click to browse
              </p>
            </label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3">
        <button
          type="submit"
          class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Start Processing
        </button>
        <button
          type="button"
          onclick="document.getElementById('modal-container').innerHTML = ''"
          class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
